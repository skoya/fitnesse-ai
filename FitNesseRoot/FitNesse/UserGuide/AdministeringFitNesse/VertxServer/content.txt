!1 Vert.x server runtime
The Vert.x runtime replaces the legacy servlet stack with async routing, EventBus wiring, and optional MCP adapters (HTTP, WebSocket, gRPC).

!2 Starting the server
 * Use !style_code(./quickrun.sh) (macOS/Linux) or !style_code(./quickrun.cmd) (Windows) for a local dev start (reads env defaults).
 * Or run !style_code(fitnesse.vertx.FitNesseVertxMain) directly: !style_code(java -cp build/classes/java/main:build/resources/main:lib/* fitnesse.vertx.FitNesseVertxMain) (use !style_code(;) instead of !style_code(:) on Windows classpaths).
 * The server redirects !style_code(/) to !style_code(/wiki/FrontPage) and serves static assets under !style_code(/files/*).
Windows quickrun uses !style_code(JAVA_HOME) when set and falls back to !style_code(java) on your !style_code(PATH).

!3 Quickrun flow
!mermaid
flowchart LR
  A[quickrun.sh / quickrun.cmd] --> B[gradlew classes + copyRuntimeLibs]
  B --> C[FitNesseVertxMain]
  C --> D[HTTP port + Slim port]
!endmermaid

!2 Key environment settings
|!meta name|!meta default|!meta description|
|FITNESSE_VERTX_PORT|8080|HTTP port for Vert.x|
|FITNESSE_ROOT_PATH|.|Root folder containing !-FitNesseRoot-!|
|FITNESSE_ROOT_DIR|FitNesseRoot|Wiki root directory name|
|FITNESSE_AUTH_ENABLED|false|Enable authentication for UI/API/MCP (Basic auth for MCP); set to true in shared environments|
|FITNESSE_MCP_WS_ENABLED|false|Enable the !-/mcp/ws-! WebSocket adapter|
|FITNESSE_MCP_GRPC_ENABLED|false|Enable the gRPC adapter (proto in !-src/fitnesse/mcp/proto-!)|
|FITNESSE_MCP_GRPC_PORT|50051|Port for the gRPC adapter when enabled|
|FITNESSE_AI_PROVIDER|echo|AI provider selection (echo/openai)|
|OPENAI_API_KEY|-(unset)-|API key for OpenAI provider|
|OPENAI_MODEL|gpt-4.1|Model name for OpenAI provider|
|FITNESSE_HTTP_TIMEOUT_MS|30000|Per-request timeout applied via Vert.x !-TimeoutHandler-!|
|FITNESSE_IDLE_TIMEOUT_SEC|60|HTTP idle timeout for server connections|
|FITNESSE_TEST_POOL_SIZE|auto (>=cores)|Worker pool size for Slim/Fit runs (defaults to max(2, available processors))|
|FITNESSE_TEST_MAX_QUEUE|auto (pool*4)|Max queued test runs before 429 backpressure; defaults to 4x pool size|
|prevent.system.exit|false|Recommended on modern JDKs to avoid SecurityManager interference with Slim SUT|
|java.security.manager|allow|Set to allow to prevent SecurityManager install errors on modern JDKs|
|SLIM_PORT|8099|Port hint for Slim runner when using quickrun.sh/quickrun.cmd (can be overridden)|

!2 vertx-config.json
If !style_code(vertx-config.json) is missing at startup, the server writes a default file with the current settings so you can edit it directly. Environment variables still override values from the file.

!2 Request timeouts
The Vert.x !-TimeoutHandler-! enforces !style_code(FITNESSE_HTTP_TIMEOUT_MS) on normal wiki/page requests, but long-running suite/test runs skip the request timeout so the browser can stay attached to the stream. If you still see timeouts, raise !style_code(FITNESSE_HTTP_TIMEOUT_MS) and re-check the run monitor logs.

!2 Run monitor and logs
Use !style_code(/run-monitor) to see queue/running/completed counts and live debug logs while suites run. The log feed is also available as JSON from !style_code(/api/run/logs?since=0&limit=200).

''UX update'': the run monitor now surfaces test system output and lifecycle events so you can see what is happening without tailing the server console.

!mermaid
flowchart LR
  A[Suite/Test run] --> B[Test runner worker pool]
  B --> C[/api/run/monitor]
  B --> D[/api/run/logs]
  C --> E[/run-monitor UI]
  D --> E
!endmermaid

!2 Plugin loading (Vert.x)
Plugins are loaded from !style_code(plugins.properties) and Java !-ServiceLoader-! providers. Vert.x plugins can register routes and adapters (MCP, AI, auth, etc.) via the Vert.x plugin registry so they can be enabled/disabled without code changes.

!2 Static files and roots
 * Static handler serves !style_code(/files/fitnesse/*) from !style_code(fitnesse/resources) and !style_code(/files/*) from the wiki !-files-! directory.
 * Keep !style_code(FITNESSE_ROOT_PATH) pointing to the folder that contains !-FitNesseRoot-! (avoid absolute !style_code(/) roots in handler configuration).
 * Legacy page URLs like !style_code(/SomePage?properties) redirect to !style_code(/wiki/SomePage?properties) so responder query parameters keep working.

!2 Live suite status
Suite/test pages show a lightweight status panel while runs are active, using the run monitor endpoints. The panel displays the current test (from run logs), queue depth, and completed count, updating every few seconds.

!2 Auth and audit
 * When !style_code(FITNESSE_AUTH_ENABLED=true), routes are protected by the shared policy rules and an auth handler (Basic or OIDC).
 * OIDC is enabled with !style_code(FITNESSE_OIDC_ENABLED=true) and issuer/client settings, or Azure Entra settings.
 * MCP adapters accept OIDC bearer tokens or Basic auth and log to !style_code(.fitnesse/audit/mcp-audit.jsonl).

!2 OAuth2 / OIDC flow
The Vert.x server validates bearer tokens (JWT) using OIDC discovery and JWKS keys. Tokens are then checked against the access policy rules.

!3 OIDC validation sequence
!plantuml
@startuml
actor User
participant "OIDC Provider" as IdP
participant "FitNesse Vert.x" as FitNesse
participant "Policy Engine" as Policy

User -> IdP: OAuth2/OIDC login\n(authorization code or client credentials)
IdP --> User: Access token (JWT)
User -> FitNesse: Request + Authorization: Bearer <token>
FitNesse -> IdP: Discover metadata + JWKS\n(cached by Vert.x)
IdP --> FitNesse: OIDC config + signing keys
FitNesse -> FitNesse: Validate JWT (issuer, audience, exp)
FitNesse -> Policy: Evaluate policy.json rules
Policy --> FitNesse: allow / deny
FitNesse --> User: Response or 401/403
@enduml
!endplantuml

!3 Azure Entra example
Azure Entra uses the tenant ID to build the issuer URL. When !style_code(FITNESSE_AZURE_TENANT_ID) is set, it takes precedence over !style_code(FITNESSE_OIDC_ISSUER).

!plantuml
@startuml
actor User
participant "Azure Entra ID" as Entra
participant "FitNesse Vert.x" as FitNesse

User -> Entra: OAuth2 login\n(tenant scoped)
Entra --> User: Access token (JWT)
User -> FitNesse: Authorization: Bearer <token>
FitNesse -> Entra: GET https://login.microsoftonline.com/{tenant}/v2.0/.well-known/openid-configuration
Entra --> FitNesse: Metadata + JWKS
FitNesse --> User: Response or 401/403
@enduml
!endplantuml

Example env configuration:
{{{
FITNESSE_AUTH_ENABLED=true
FITNESSE_AZURE_TENANT_ID=contoso.onmicrosoft.com
FITNESSE_AZURE_CLIENT_ID=00000000-0000-0000-0000-000000000000
FITNESSE_AZURE_AUDIENCE=api://fitnesse (optional)
}}}

!2 Policy file
Policies are defined in !style_code(.fitnesse/policy.json) with optional overrides under nested folders. The closest folder policy wins, and deny rules block lower overrides unless ''allowOverride'' is true.
