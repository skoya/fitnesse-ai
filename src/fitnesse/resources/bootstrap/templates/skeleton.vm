<!DOCTYPE html>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>$title</title>
  ## Deal with HTML 5 element in older IE browsers
  <!--[if lt IE 9]>
   <script>
    document.createElement('header');
    document.createElement('nav');
    document.createElement('section');
    document.createElement('article');
    document.createElement('footer');
   </script>
  <![endif]-->

  <link rel="shortcut icon" type="image/png" href="${contextRoot}files/fitnesse/images/favicon.png" />
  <link rel="stylesheet" type="text/css" href="${contextRoot}files/fitnesse/css/fitnesse_wiki.css" />
  <link rel="stylesheet" type="text/css" href="${contextRoot}files/fitnesse/css/fitnesse_pages.css" />
  <link rel="stylesheet" type="text/css" href="${contextRoot}files/fitnesse/css/${theme}.css" />
  <link rel="stylesheet" type="text/css" href="${contextRoot}files/fitnesse/wysiwyg/wysiwyg.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="${contextRoot}files/fitnesse/bootstrap/css/fitnesse-bootstrap.css">

  <script src="${contextRoot}files/fitnesse/javascript/jquery-3.5.1.min.js" type="text/javascript"></script>
  <script src="${contextRoot}files/fitnesse/javascript/fitnesse.js" type="text/javascript"></script>
  <script src="${contextRoot}files/fitnesse/javascript/${theme}.js" type="text/javascript"></script>
  <script src="${contextRoot}files/fitnesse/javascript/mermaid.min.js" type="text/javascript"></script>
  <script src="${contextRoot}files/fitnesse/javascript/diagram-renderer.js" type="text/javascript"></script>
  <script src="${contextRoot}files/fitnesse/javascript/theme-switcher.js" type="text/javascript"></script>

  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" type="text/javascript"></script>
  <script src="${contextRoot}files/fitnesse/bootstrap/js/bootstrap.js" type="text/javascript"></script>
  <script src="${contextRoot}files/fitnesse/bootstrap/js/respond.js" type="text/javascript"></script>

 </head>
<body#if( $bodyClass ) class="$bodyClass"#end data-theme="$theme" data-color-mode="light">

  <nav class="navbar-expand-md fixed-top" role="navigation">
   <div class="navbar justify-content-start bg-light border">
   <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
     <a class="navbar-brand" href="${contextRoot}FrontPage"><span class="d-none">FitNesse</span></a>
    </div>

    #parse( $navTemplate )
    #if( $!errorNavTemplate )
     #parse( $errorNavTemplate )
    #end

   </div>
   #parse( 'breadcrumb.vm' )
  </nav>

  <header>
   #parse( $headerTemplate )
  </header>

  <aside id="ai-dock">
   <button id="ai-toggle" type="button">AI</button>
    <div id="ai-panel" class="hidden">
     <div id="ai-warning" class="ai-warning hidden">AI provider not configured. Set OPENAI_API_KEY or switch provider.</div>
     <div class="ai-header">AI Assistant</div>
    <select id="ai-tool">
     <option value="assist">Assist</option>
     <option value="test-gen">Generate Test</option>
    </select>
    <input id="ai-pagePath" placeholder="Page path" />
    <input id="ai-fixture" placeholder="Fixture name" />
    <textarea id="ai-prompt" placeholder="Ask for help..."></textarea>
    <button id="ai-send" type="button">Send</button>
    <pre id="ai-response"></pre>
   </div>
  </aside>

  <article>
   #parse( $mainTemplate )
  </article>

  #if( $!footerTemplate )
  <footer>
   #parse( $footerTemplate )
  </footer>
  #end

  <script>
   function adjustPadding() {
    if(document.querySelector('nav')) {
     var navHeight = document.querySelector('nav').offsetHeight;
     document.body.style.paddingTop = navHeight + 'px';
    }
   }

   // Making sure the padding is correct when loading a page
   window.onload = adjustPadding;

   // Changing the padding when the window gets resized
   window.onresize = adjustPadding;
  </script>

  <style>
   #ai-dock { position: fixed; right: 12px; bottom: 12px; z-index: 1000; }
   #ai-toggle { background: #1f6feb; color: #fff; border: 0; padding: 8px 12px; border-radius: 4px; }
   #ai-panel { margin-top: 8px; width: 320px; background: #fff; border: 1px solid #ddd; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
   #ai-panel.hidden { display: none; }
   #ai-panel .ai-warning { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 6px 8px; margin-bottom: 6px; border-radius: 4px; font-size: 0.9em; }
   #ai-panel .ai-warning.hidden { display: none; }
   #ai-panel textarea { width: 100%; height: 120px; }
   #ai-panel input, #ai-panel select { width: 100%; margin: 6px 0; padding: 6px; }
   #ai-panel pre { background: #f7f5f0; border: 1px solid #eee; padding: 8px; white-space: pre-wrap; }
   .ai-header { font-weight: bold; margin-bottom: 6px; }
  </style>
  <script>
   (function() {
     var toggle = document.getElementById('ai-toggle');
     var panel = document.getElementById('ai-panel');
     var send = document.getElementById('ai-send');
     var warning = document.getElementById('ai-warning');
     if (!toggle || !panel || !send) { return; }
     toggle.onclick = function() { panel.classList.toggle('hidden'); };
     if (warning) {
       fetch('${contextRoot}api/ai/config').then(function(res) {
         return res.json();
       }).then(function(cfg) {
         if (cfg && cfg.provider === 'openai' && !cfg.hasApiKey) {
           warning.classList.remove('hidden');
         }
       }).catch(function() {
         // Ignore config fetch errors.
       });
     }
     send.onclick = function() {
       var prompt = document.getElementById('ai-prompt').value || '';
       var tool = document.getElementById('ai-tool').value || 'assist';
       var pagePath = document.getElementById('ai-pagePath').value || '';
       var fixture = document.getElementById('ai-fixture').value || '';
       var params = {};
       if (pagePath) { params.pagePath = pagePath; }
       if (fixture) { params.fixture = fixture; }
       fetch('${contextRoot}api/ai/assist', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ prompt: prompt, tool: tool, params: params })
       }).then(function(r) { return r.json(); })
       .then(function(j) { document.getElementById('ai-response').textContent = j.response || ''; });
     };
   })();
  </script>

 </body>
</html>
